using Microsoft.EntityFrameworkCore;
using ToDo.Api;
using Microsoft.OpenApi.Models;
using System.Text.Json.Serialization;

/// <summary>
/// ????? ????? ??? ??????? ToDo API.
/// ??? ???? ?????????? ?? ??????????? ???-??????? ASP.NET Core ? Entity Framework,
/// ????????????? Swagger, ??????????????? ????????? ?????? ?? API ????????????.
/// </summary>
/// <remarks>
/// ??????? ????? RESTful API ??? ?????????? ?????????? ToDo ? ?????????? ?????????:
/// - CRUD ???????? ??? ????????? ToDo
/// - ?????????? ???? ????? SQLite ????? Entity Framework Core
/// - ???????????? Swagger/OpenAPI ??? API ???????? ?????
/// - ?????????????? ????????? ?????? ??? ??? UI
/// - ????????????? ?? ?????? ??????????? ??? API ???????? ?????
/// - ???????????? ?????????? ??? ???????? (??????? ???????? ???? ?????, Swagger UI)
/// </remarks>
WebApplicationBuilder builder = WebApplication.CreateBuilder(args);

/// <summary>
/// ???????????? Entity Framework Core ? ??????????? ???? ????? SQLite.
/// ?????????? ???????? TodoDb ??? ???????????? ???? ????? SQLite ? ?????? ??????????? ? ????????????.
/// </summary>
/// <remarks>
/// ????? ??????????? ??????????? ? appsettings.json ??? "ConnectionStrings:DefaultConnection".
/// ???? ???? ????? SQLite ???? ?????????, ???? ??? ?? ?????.
/// </remarks>
builder.Services.AddDbContext<TodoDb>(options =>
    options.UseSqlite(builder.Configuration.GetConnectionString("DefaultConnection")));

/// <summary>
/// ????? ?????? ???????? ???????? ?????????? ???? ????? ??? ?????????? ???????? ??????? ??? ??? ????????.
/// ????? ???????? ?????????? ??? ??????? ???'????? ? ????? ????? ???? ???????? ???? ????? ???????? ???????.
/// </summary>
/// <remarks>
/// ??? ?????? ? ????????? ???????? ??? ??? ???????? ??? ??????????? ??????? ???'?????? ? Entity Framework.
/// ??? ??????? ???????? ?????????? ??? ??????? ???? ????? ????????? ?????????? ????????.
/// </remarks>
builder.Services.AddDatabaseDeveloperPageExceptionFilter();

/// <summary>
/// ???????????? MVC ??????????? ? ??????????? ??????? ???????????? JSON.
/// ??????? ????????????? ?? ?????? ??????????? ?? API ??????? ????? ? ?????????? ???????? JSON.
/// </summary>
/// <remarks>
/// ??????????? ????? JSON:
/// - JsonStringEnumConverter: ?????????? ????? ?? ????? ??????? ?????
/// - ReferenceHandler.IgnoreCycles: ????????? ????????? ????????? ???????? ? ?????? ??'?????
/// </remarks>
builder.Services.AddControllers()
    .AddJsonOptions(options =>
    {
        // ????????? ????? ? ??????? ????????????? ? JSON (?????????, "High" ??????? 3)
        options.JsonSerializerOptions.Converters.Add(new JsonStringEnumConverter());
        // ???????? ???????? ????????? ? ?????? ??'?????
        options.JsonSerializerOptions.ReferenceHandler = ReferenceHandler.IgnoreCycles;
    });

/// <summary>
/// ???????????? API Explorer ??? ????????????? ????????? ???????? ????? API.
/// ????????? ??? ?????? ????????? ???????????? Swagger/OpenAPI ? ????????????.
/// </summary>
/// <remarks>
/// ??? ?????? ?????? ??????? ??? ???????? ????? API ?? ?????? ?? ??????????
/// ??? ????????? ???????????? Swagger.
/// </remarks>
builder.Services.AddEndpointsApiExplorer();

/// <summary>
/// ???????????? ????????? ???????????? Swagger/OpenAPI ? ??????????????? ??????????????.
/// ?????????? ??????????? ???????????? API ? ?????????? ?????????????? ?? ???????????? ?????.
/// </summary>
/// <remarks>
/// ???????????? ???????:
/// - ???????? API (?????, ??????, ????)
/// - ??????????? ???? DateOnly ??? ?????????? ????????? ????? OpenAPI
/// - ????????? nullable ????? DateOnly
/// 
/// ??????????? ???????????? ???? ???????? ?? ???????? ????? /swagger ??? ??? ????????.
/// </remarks>
builder.Services.AddSwaggerGen(c =>
{
    // ???????? ???????? ???????? API ? ??????????
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "ToDo API",
        Version = "v1",
        Description = "?????????? ToDo API ???????? ? ASP.NET Core ?? ????? CRUD ???????? ??? ?????????? ??????????"
    });
    
    /// <summary>
    /// ????????? ??? DateOnly ? ???????? ???? OpenAPI.
    /// ????????? ???? ?? DateOnly ? ????? .NET 6+ ???? ???????? ?????? ??????????? ??? Swagger.
    /// </summary>
    c.MapType<DateOnly>(() => new OpenApiSchema
    {
        Type = "string",
        Format = "date"
    });
    
    /// <summary>
    /// ????????? nullable ??? DateOnly ? ???????? ???? OpenAPI.
    /// ???????? ??????????? ???? ???? ? ??????? API.
    /// </summary>
    c.MapType<DateOnly?>(() => new OpenApiSchema
    {
        Type = "string",
        Format = "date",
        Nullable = true
    });
});

/// <summary>
/// ??????? ???????????? ????????? ???-???????.
/// ??????? ??????? ? ????? ?????????? ????????????? ????????? ?? middleware.
/// </summary>
WebApplication app = builder.Build();

/// <summary>
/// ??????? middleware ??? ?????????????? ????????? ??????.
/// ???????? ??????? ????????????? ???????? ????? (HTML, CSS, JavaScript) ? ?????????? wwwroot.
/// </summary>
/// <remarks>
/// ???????? ????? ?????????????? ????????????? ??? ??????? ?? ???????? ???????????????? ???:
/// - ????? ??? UI (HTML, CSS, JavaScript)
/// - ??????????, ?????? ?? ???? ???????
/// - ????? ???????????? ???????
/// </remarks>
app.UseStaticFiles();

/// <summary>
/// ???????????? middleware Swagger ?????? ??? ?????????? ????????.
/// ??????? ??????? ????? Swagger JSON ?? ????????????? Swagger UI ??? ?????????? API ?? ????????????.
/// </summary>
/// <remarks>
/// ???????????? ?????? ??? ???????? ???????:
/// - ??????? ????? ????????? Swagger JSON: /swagger/v1/swagger.json
/// - ????????????? Swagger UI: /swagger
/// 
/// ?? middleware ???????? ? ?????????? ? ????????? ??????? ?? ??????????????.
/// </remarks>
if (app.Environment.IsDevelopment())
{
    // ??????? ??????? ????? Swagger JSON
    app.UseSwagger();
    // ??????? ????????????? Swagger UI
    app.UseSwaggerUI();
}

/// <summary>
/// ???????????? ?????????? ???????? ??? ??????????????? ?? ???????? ???-?????????.
/// ????????? ????????? URL ??????? ("/") ??? ??????????????? ???????????? ?? ??????? HTML ????????.
/// </summary>
/// <remarks>
/// ?? ????? ?????? ??????? ???????? ??? ???????????? ?? ???????? ?? ?????? ???????.
/// ??????????????? ?????? ?? index.html ???? ??????? ??????? ???????? ??? UI.
/// </remarks>
app.MapGet("/", () => Results.Redirect("/index.html"));

/// <summary>
/// ??????? ????????????? ?? ?????? ???????????.
/// ????????? ??? ??? ??????????? ? ?? ???????????? ?????????? ?? ?????? ????????? ?????????? ?? ???.
/// </summary>
/// <remarks>
/// ?? ??????? ??? ?????????? ? ??????? ??? ??????? HTTP ??????? ?? ?????? ?? ???????????? ?????????????.
/// ?????????? ?????????????? ???????? ?? [Route], [HttpGet], [HttpPost], ???? ??? ?????????? ????? ???????? ?????.
/// </remarks>
app.MapControllers();

/// <summary>
/// ???????? ???-??????? ?? ??????? ??????????????? HTTP ???????.
/// ?? ?????????? ???????? ??? ???????? ??????? ?? ???? ??????????.
/// </summary>
/// <remarks>
/// ??????? ???? ?????????????? ?? ???????????? ?????? (???????? HTTPS ?? HTTP).
/// ??? ????? ?????????? ?? ?????????? ??????? (Ctrl+C, SIGTERM, ????).
/// </remarks>
await app.RunAsync();